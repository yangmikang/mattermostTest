<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.distep.statis.service.impl.StatisMapper">



	<resultMap id="statisResultMap"
		type="kr.go.distep.statis.vo.StatisVo">
		<result column="rnum" property="rnum" />
		<result column="log_date" property="logDate" />
		<result column="log_month" property="logMonth" />
		<result column="request_count" property="requestCount" />
	</resultMap>




	<select id="getMonthlyTotalRequests" resultMap="statisResultMap"
		parameterType="hashMap">
		SELECT
		ROW_NUMBER() OVER (ORDER BY log_month DESC) AS
		rnum,
		t.log_month,
		t.request_count
		FROM (
		SELECT
		DATE_FORMAT(log_time,
		'%Y-%m') AS log_month,
		COUNT(*) AS request_count
		FROM request_log
		GROUP
		BY DATE_FORMAT(log_time, '%Y-%m')
		) t
		ORDER BY t.log_month DESC
	</select>

	<select id="getDailyTotalRequests" resultMap="statisResultMap"
		parameterType="hashMap">
		SELECT
		ROW_NUMBER() OVER (ORDER BY DATE(log_time) DESC)
		AS rnum,
		DATE(log_time) AS log_date,
		COUNT(*) AS request_count
		FROM
		request_log
		GROUP BY log_date
		ORDER BY log_date DESC
	</select>

	<select id="getDailyRequestsByRole" resultMap="statisResultMap"
		parameterType="hashMap">
		SELECT
		ROW_NUMBER() OVER (ORDER BY DATE(rl.log_time)
		DESC, m.role) AS rnum,
		m.role,
		DATE(rl.log_time) AS log_date,
		COUNT(*) AS
		request_count
		FROM
		request_log rl
		JOIN
		member m ON rl.user_id = m.id
		WHERE
		rl.user_id !=
		'anonymous'
		GROUP BY
		m.role, log_date
		ORDER BY
		log_date DESC,
		m.role
	</select>

	<select id="getMonthlyRequestsByRole"
		resultMap="statisResultMap" parameterType="hashMap">
		SELECT
		ROW_NUMBER() OVER
		(ORDER BY DATE_FORMAT(rl.log_time, '%Y-%m') DESC,
		m.role) AS rnum,
		m.role,
		DATE_FORMAT(rl.log_time, '%Y-%m') AS log_month,
		COUNT(*) AS
		request_count
		FROM request_log rl
		JOIN member m ON m.id =
		rl.user_id
		WHERE rl.user_id != 'anonymous'
		GROUP BY m.role, log_month
		ORDER BY
		log_month DESC, m.role
	</select>



</mapper>
