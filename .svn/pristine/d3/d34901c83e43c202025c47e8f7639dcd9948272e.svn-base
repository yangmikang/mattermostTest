<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GINI - Global Innopolis Network Initiative</title>
  <link rel="apple-touch-icon" sizes="180x180" href="../../resources/img/guide/favicon_180.png">
  <link rel="icon" type="image/png" sizes="512x512" href="../../resources/img/guide/favicon_512.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="../../resources/img/guide/favicon_192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../resources/img/guide/favicon_32.png">
  <link href="../../resources/css/swiper-bundle.min.css" rel="stylesheet" />
  <link href="../../resources/css/pattern_css.css" rel="stylesheet" />
  <link href="../../resources/css/output/p_common.css" rel="stylesheet" />
  <link href="../../resources/css/output/p_content.css" rel="stylesheet" />
  <link href="../../resources/css/output/p_layout.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/ko.global.min.js"></script>
</head>
<style>
 .search-list .card-body .c-text:hover{
  background-color: transparent !important;
  box-shadow: none !important;
  border: none !important;
  outline: none !important;
  text-decoration: none !important;
  cursor: default !important;
}


/* 썸네일 리스트에만 적용 */
.thumbnail-list .card-body {
	display: flex;
	align-items: normal !important;
	justify-content: flex-start;
	flex-direction: column !important;
	gap: var(--krds-spacer-6);
}

.thumbnail-list .li {
	position: relative;
	display: flex;
	align-items: normal !important;
	justify-content: flex-start;
	flex-direction: column !important;
	gap: var(--krds-spacer-6) 0;
	padding: var(--krds-spacer-6) !important;
	overflow-x: auto;
	box-sizing: border-box;
	border-radius: var(--krds-rd-12);
	border: 0.1rem solid var(--krds-gray-40);
}

</style>
<body>
  <div id="container">
  
 <!--  <button onclick="changeSort()">AJAX 호출 테스트</button> -->
  
    <div class="page-title-wrap visual img-members">
      <div class="visual-filter"></div>
      <div class="inner">
        <nav class="breadcrumb-wrap" aria-label="브레드크럼">
          <ol class="breadcrumb">
            <li class="home"><a href="#" class="txt">Home</a></li>
            <li><a href="#" class="txt breadcrumb-menu">BOARD</a></li>
            <li><a href="#" class="txt breadcrumb-menu">Q&A</a></li>
          </ol>
        </nav>
        <div class="visual-area">
          <h2 class="h-tit board-title">Q&A</h2>
          <p class="board-desc">Board description</p>
        </div>
      </div>
    </div>

    <div class="inner">
      <div class="board-box">
        <div class="search-top-box">
          <div class="sch-form-wrap flex">
            <div class="sch-input">
              <input type="text" class="form-control searchKeyword" id="searchKeyword" placeholder="Enter Keyword" title="Enter Keyword">
              <button type="button" class="btn btn-ico ico-sch" id="search"><span class="sr-only">검색</span></button>
            </div>
            <button type="button" class="btn btn-txt primary" style="width: 150px;" onclick="location.href='${pageContext.request.contextPath}/board/qnaregister.do'">Write Post</button>
          </div>
        </div>

        <div class="search-list-top type1">
          <div class="sch-info" role="region" aria-live="polite">
            Total <span class="keyword">00</span>
          </div>
        </div>

        <ul class="search-list type1  stb-list"></ul>

<!-- 썸네일 게시판 리스트 -->
<ul class="search-list type2 thumbnail-list" style="display:none;"></ul>
        <div class="pagination w-page paging">
          <div class="row justify-content-center" id="divPagingArea"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="../../resources/js/pattern/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="../../resources/js/pattern/ui-pattern-script.js"></script>
  <script src="../../resources/js/component/ui-script.js"></script>
<script>
  // contextPath를 JSP에서 미리 선언해둠
  const contextPath = '${pageContext.request.contextPath}';

  // 초기 리스트 로딩
  changeSort();

  // 검색 이벤트 바인딩
  document.getElementById("search").addEventListener("click", function () {
    const keyword = document.getElementById("searchKeyword").value;
    changeSort(1, keyword);
  });
  function changeSort(currentPage = 1, keyword = '') {
	  const data = { currentPage, keyword };

	  axios.post(`\${contextPath}/board/listQnaAjax.do`, data)
	    .then(function (res) {
	      const list = res.data.content || [];
	      document.querySelector(".keyword").innerText = res.data.total || 0;

	      const type1List = document.querySelector(".stb-list");
	      type1List.innerHTML = '';
	      type1List.style.display = 'block';

	      let html = '';

	      for (const item of list) {
	        const qnaId = item.qnaId;
	        const content = item.content?.length > 100 ? item.content.slice(0, 100) + '...' : item.content || '';
	        const username = item.username || '';
	        const regDate = item.regDate || '';
	        const flagIcon = getFlagIcon(item.cityCode || '');
	        const detailUrl = contextPath + "/board/detail.do?boardCode=" + (item.boardCode || '');
	       let answerHtml = ''
	        
	        if (item.aswContent) {
	        	  // 답변 있음
	        	  answerHtml += `
	        	    <div class="answer-view" id="answerText-\${qnaId}">
	        	      <p class="c-txt"><strong class="key">\${item.aswContent}</strong></p>
	        	      <p class="c-txt"><strong class="key">\${item.adminId}</strong></p>
	        	      <p class="c-txt"><strong class="key">\${item.createAtAsw}</strong></p>
	        	      <button class="btn sm secondary" 
	        	              onclick="enableEdit('\${qnaId}')"
	        	              data-content="\${item.aswContent}">수정</button>
	        	      <button class="btn sm danger" onclick="deleteAnswer('\{qnaId}')">삭제</button>
	        	    </div>
	        	    <div class="answer-edit" id="editBox-\${qnaId}" style="display:none;">
	        	      <textarea id="editInput-\${qnaId}" class="form-control" rows="4" style="width:100%; margin-bottom:8px;"></textarea>
	        	      <button class="btn md primary" onclick="submitAnswer('\${qnaId}', true)">수정 저장</button>
	        	    </div>
	        	  `;
	        	} else {
	        	  // 답변 없음
	        	  answerHtml += `
	        	    <p class="c-txt"><strong>아직 답변이 등록되지 않았습니다.</strong></p>
	        	    <textarea id="answerInput-\${qnaId}" class="form-control" rows="4" style="width:100%; margin-bottom:8px;"></textarea>
	        	    <button class="btn md primary" onclick="submitAnswer('\${qnaId}')">답변 등록</button>
	        	  `;
	        	}


	        html += `
	          <li class="li">
	            <div class="card-body" onclick="answerOn('\${qnaId}')">
	              <a href="#" class="c-text">
	                <p class="c-tit"><span class="span">\${item.title}</span></p>
	                <p class="c-txt">\${content}</p>
	                <p style="display:flex; align-items:center;">
	                  <strong class="key"></strong>
	                  <span class="value" style="display:flex; align-items:center;">
	                    <img src="${contextPath}/img/component/common/${flagIcon}" />
	                    ${username}
	                  </span>
	                </p>
	                <p class="c-date">
	                  <strong class="key" style="display: flex;justify-content: flex-end;">${regDate}</strong>
	                </p>
	              </a>
	              <div class="c-btn">
	                <a href="${detailUrl}" class="btn md secondary" title="View Details">View Details</a>
	              </div>
	            </div>
	          </li>
	          <li class="answer-box" id="answerBox-\${qnaId}" style="display:none;">
	            \${answerHtml}
	          </li>
	        `;
	      }

	      type1List.innerHTML = html;
	    })
	    .catch(function (err) {
	      console.error('QnA 목록 조회 실패:', err);
	    });
	}
  function answerOn(qnaId) {
	  document.querySelectorAll(".answer-box").forEach(el => el.style.display = 'none');
	  const target = document.querySelector(`#answerBox-\${qnaId}`);
	  if (target) {
	    const isVisible = target.style.display === 'block';
	    target.style.display = isVisible ? 'none' : 'block';
	  }
	}
  function enableEdit(qnaId) {
	  const answerView = document.querySelector(`#answerText-\${qnaId}`);
	  const editBox = document.querySelector(`#editBox-\${qnaId}`);
	  const textarea = document.querySelector(`#editInput-\${qnaId}`);
	  const content = answerView.querySelector("button[data-content]").dataset.content || '';

	  answerView.style.display = 'none';
	  editBox.style.display = 'block';
	  textarea.value = content;
	}


	function submitAnswer(qnaId, isUpdate = false) {
	  const textareaId = isUpdate ? `editInput-\${qnaId}` : `answerInput-\${qnaId}`;
	  const textarea = document.getElementById(textareaId);
	  const content = textarea?.value?.trim();

	  if (!content) {
	    alert("답변 내용을 입력해주세요.");
	    return;
	  }

	  axios.post(`\${contextPath}/board/answerInsert.do`, {
	    qnaId: qnaId,
	    aswContent: content
	  })
	    .then(res => {
	      alert(isUpdate ? "답변이 수정되었습니다." : "답변이 등록되었습니다.");
	      changeSort();
	    })
	    .catch(err => {
	      console.error("답변 등록 실패", err);
	      alert("처리 중 오류가 발생했습니다.");
	    });
	}

	function deleteAnswer(qnaId) {
		alert("qnaId",qnaId)
	  if (!confirm("정말 삭제하시겠습니까?")) return;
		
	  axios.post(`\${contextPath}/board/answerDelete.do`, { qnaId })
	    .then(res => {
	      alert("답변이 삭제되었습니다.");
	      changeSort();
	    })
	    .catch(err => {
	      console.error("삭제 실패", err);
	      alert("삭제 중 오류가 발생했습니다.");
	    });
	}

  function submitAnswer(qnaId) {
	  const textarea = document.getElementById(`answerInput-\${qnaId}`);
	  const content = textarea?.value?.trim();

	  if (!content) {
	    alert("답변 내용을 입력해주세요.") ;
	    return;
	  }
	console.log("textarea",qnaId)
	  axios.post(`\${contextPath}/board/answerInsert.do`, {
	    qnaId: qnaId,
	    aswContent: content
	  })
	  .then(res => {
	    alert("답변이 등록되었습니다.");
	    changeSort(); // 리스트 다시 로드
	  })
	  .catch(err => {
	    console.error("답변 등록 실패", err);
	    alert("등록 중 오류가 발생했습니다.");
	  });
	}

  function getFlagIcon(cityCode) {
    switch (cityCode) {
      case "01": return 'ico_korea.svg';
      case "02": return 'ico_germany.svg';
      case "03": return 'ico_spain.svg';
      case "04":
      case "05": return 'ico_usa.svg';
      case "06": return 'ico_canada.svg';
      default: return '';
    }
  }

  // 페이징 이벤트 재바인딩
  function bindPagingEvents() {
    document.querySelectorAll(".clsPagingArea").forEach(function (el) {
      el.addEventListener("click", function (e) {
        e.preventDefault();
        const currentPage = parseInt(this.dataset.currentPage);
        const keyword = this.dataset.keyword || '';
        changeSort(currentPage, keyword);
      });
    });
  }

  function thumOff() {
    document.querySelector(".thumbnail-list").style.display = 'none';
    document.querySelector(".stb-list").style.display = 'block';
  }
</script>

</body>
</html>
