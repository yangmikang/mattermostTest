<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
	<meta name="keywords" content="" />
	<meta name="description" content="" />
	<meta name="format-detection" content="telephone=no" />
	<link rel="apple-touch-icon" sizes="180x180" href="../../resources/img/guide/favicon_180.png">
	<link rel="icon" type="image/png" sizes="512x512" href="../../resources/img/guide/favicon_512.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="../../resources/img/guide/favicon_192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../../resources/img/guide/favicon_32.png">
	<title>GINI - Global Innopolis Network Initiative</title>
	<link href="../../resources/css/swiper-bundle.min.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/pattern_css.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/output/p_common.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/output/p_content.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/output/p_layout.css" type="text/css" rel="stylesheet" />

	 <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
	<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/ko.global.min.js"></script>

<title>Insert title here</title>
</head>
<body>
<div id="wrap">
		<!-- 본문 바로가기 영역 -->
		<!-- //본문 바로가기 영역 -->
		<!-- 상단 배너영역 -->
		<!-- //상단 배너영역 -->

		<!-- 헤더 영역 -->
				<!-- //헤더 상단 기타메뉴 -->
			<!-- //헤더 컨텐츠 영역  -->
			
			<!-- 모바일 : 전체메뉴 -->
		<!-- //헤더 영역 -->

		<!-- 컨테이너 영역 -->
		<div id="container">
		<form class="form-horizontal" id="form" action="${pageContext.request.contextPath}/calendar/delete.do"
	method="post" enctype="multipart/form-data">
		<input type="hidden" id="getId" name="id" value="${calendar.id}">
			<!-- breadcrumb -->
			
			
			<nav class="breadcrumb-wrap" aria-label="브레드크럼">
				<ol class="breadcrumb">
					<li class="home"><a href="#" class="txt">Home</a></li>
					<li><a href="#" class="txt">Programs</a></li>
					<li><a href="#" class="txt">Event</a></li>
				</ol>
			</nav>
			<!-- breadcrumb -->

			<!-- 컨텐츠 영역 -->
			<div class="inner">
				<!-- 페이지 타이틀 영역 -->
				<div class="page-title-wrap">
					<h2 class="h-tit">Schedule Management</h2>
					
		
					<p>Quickly upload current and bla bla</p>
						<button type="button" class="btn primary"onclick="location.href='${pageContext.request.contextPath}/calendar.do'">Go to list</button>
	
				</div>
				<!-- //페이지 타이틀 영역 -->
				<!-- 일정등록 폼 -->
				 <div class="gini-cont-wrap">
					<div class="gini-cont-box">
						<div class="row cont100">
							<!-- 폼그룹 left -->
							<div class="cont-left cont50">
								<!-- 폼그룹 -->
								<div class="form-group">
									<div class="form-tit">
										<label for="consult_name">Event Title</label>
									</div>
									<div class="form-conts">
										<input type="text" id="consult_name" class="form-control delread" value="${calendar.eventTitle}" placeholder="Event Title" readonly>
									</div>
								</div>
								<!-- //폼그룹 -->
								<!-- 날짜 입력 필드 폼그룹 -->
								<div class="form-group">
									<div class="form-tit">
										<label for="cal">Start Date & Time</label>
									</div>
									<div class="form-conts form-row">
										<div class="form-conts datepicker-conts">
											<div class="datepicker-input">
												<fmt:formatDate value="${calendar.startDatetime}" pattern="yyyy-MM-dd'T'HH:mm" var="formattedStart" />
											
												<input type="text" readonly class="form-control  datepicker cal delread" value="${formattedStart}" id="startdate" placeholder="Select date" id="cal">
												<button type="button" class="form-btn-datepicker">
													<span class="sr-only">달력 열기</span>
												</button>
											</div>
										</div>
									</div>
								</div>
								<!-- //날짜 입력 필드 폼그룹 -->
								<!-- 날짜 입력 필드 폼그룹 -->
								<div class="form-group">
									<div class="form-tit">
										<label for="cal">End Date & Time</label>
									</div>
									<div class="form-conts form-row">
										<div class="form-conts datepicker-conts">
											<div class="datepicker-input">
												<fmt:formatDate value="${calendar.endDatetime}" pattern="yyyy-MM-dd'T'HH:mm" var="endDatetime"/>
												<input type="text" readonly class="form-control  datepicker cal" value="${endDatetime}" id="enddate" placeholder="Select date" id="cal">
												<button type="button" class="form-btn-datepicker">
													<span class="sr-only">달력 열기</span>
												</button>
											</div>
										</div>
									</div>
								</div>
								<!-- //날짜 입력 필드 폼그룹 -->
								<!-- 폼그룹 -->
								<%-- <div class="form-group">
									<div class="form-tit">
										<label for="">Contact</label>
									</div>
									<div class="form-conts">
										<input type="tel" readonly id="" class="form-control delread" value="${calendar.contact}" placeholder="Contact">
									</div>
								</div> --%>
								<!-- //폼그룹 -->
								<!-- <div class="form-group margin-b">
									<div class="form-tit lg">
										<label for="">Upload Thumbnail</label>
									</div>
									<div class="form-conts row">
										<input id="userId" readonly type="text" maxlength="16"  class="form-control delread">
										<button type="button" class="btn lg secondary"> Search </button>
									</div>
									<p class="form-hint info"> 
Allow up to 00 bytes </p>
								</div> -->
							</div>
							<!-- //폼그룹 left -->
							<!-- cont-right -->
							<div class="cont-right cont50">
								<!-- 폼그룹 -->
								<%-- <div class="form-group">
									<div class="form-tit">
										<label for="consult_name">Event Description</label>
									</div>
									<div class="form-conts">
										<input type="text" readonly id="description" class="form-control delread" value="${calendar.eventDescription}" placeholder="Event Description">
									</div>
								</div> --%>
								<!-- //폼그룹 -->
								<!-- 폼그룹 -->
								<div class="form-group">
									<div class="form-tit">
										<label for="consult_name">Organizer</label>
									</div>
									<div class="form-conts">
										<select class="form-select lg delDis" id="selectOrg" name="organizer" title="선택" disabled>
										    <option value="">select</option>
										    <option value="GINI" ${calendar.organizer == 'GINI' ? 'selected' : ''}>GINI</option>
										    <option value="City of Daejeon" ${calendar.organizer == 'City of Daejeon' ? 'selected' : ''}>City of Daejeon</option>
										    <option value="City of Dortmund" ${calendar.organizer == 'City of Dortmund' ? 'selected' : ''}>City of Dortmund</option>
										    <option value="City of Malaga" ${calendar.organizer == 'City of Malaga' ? 'selected' : ''}>City of Malaga</option>
										    <option value="County of Montgomery, MD" ${calendar.organizer == 'County of Montgomery, MD' ? 'selected' : ''}>County of Montgomery, MD</option>
										    <option value="City of Seattle" ${calendar.organizer == 'City of Seattle' ? 'selected' : ''}>City of Seattle</option>
										    <option value="Province of Quebec" ${calendar.organizer == 'Province of Quebec' ? 'selected' : ''}>Province of Quebec</option>
										</select>

									</div>
								</div>
								<!-- //폼그룹 -->
					<%-- 			<div class="form-group">
									<div class="form-tit">
										<label for="consult_name">Location</label>
									</div>
									<div class="form-conts">
										<input type="text" readonly id="" class="form-control delread" value="${calendar.location}" placeholder="Location 넣을지 말지 협의 필요">
									</div>
								</div> --%>
								<%-- <div class="form-group">
									<div class="form-tit">
										<label for="consult_name">External Link</label>
									</div>
									<div class="form-conts">
										<input type="text" id="" readonly class="form-control delread" value="${calendar.externalLink}" placeholder="https://example.com">
									</div>
								</div> --%>
								<div class="form-group chk-area">
									<div class="form-tit">
										<label for="consult_name">Event Status</label>
									</div>
									<div class="form-conts form-row">
									  <div class="form-check lg">
										  <input type="radio" name="eventStatus" id="upcoming" value="UPCOMING"  class="delDis"disabled="disabled"
										         ${calendar.eventStatus == 'UPCOMING' ? 'checked' : ''}>
										  <label for="upcoming">Upcoming</label>
										</div>
										
									<div class="form-check lg">
									  <input type="radio" name="eventStatus" id="ongoing" value="ONGOING" class="delDis" disabled="disabled"
									         ${calendar.eventStatus == 'ONGOING' ? 'checked' : ''}>
									  <label for="ongoing">Ongoing</label>
									</div>

									</div>

								</div>
								<!-- //폼 끝 -->
							<!-- //cont-right -->
						</div>
					</div>

					<div class="gini-cont-box">
						<div class="fileCont" >
							<!-- 파일업로드 -->
							<div class="file-upload " ondragover="f_over()"   ondrop="f_drop()" style="display: none;">
								<p class="txt">Please drag and drop the file you wish to attach here, or click the Select File button to select the file directly.</p>
								<button type="button" class="btn primary ico-before ico-upload md" onclick="document.getElementById('uploadFiles').click()">
									Select file</button>
							</div>
							<%-- <c:if test="${calendar.fileGroupVO != null}"> --%>

       <c:forEach var="fileDetailVO" items="${calendar.fileGroupVO.fileDetailVOList}">
  <input type="hidden" name="existingFileIds" value="${fileDetailVO.fileSn}" />
</c:forEach>
       
           
        <div class="file-upload-result ">
            <img class="img-fluid imgFileSaveLocate"
                     style="cursor: pointer; display: none;" src="${fileDetailVO.fileSaveLocate}"
                     data-file-original-name="${fileDetailVO.fileOriginalName}"
                     data-file-save-locate="${fileDetailVO.fileSaveLocate}" /> 
               <!--  <button type="button"  class="prev" >미리보기</button> -->
                <button type="button" class="down allDown" onclick="fn_dw()">전체 다운로드</button>
								<div class="upload-top">
									<div class="file-total">
										<span class="current fileCount">
												    <span class="current fileCount">
													  ${calendar.fileGroupVO.fileDetailVOList != null ? calendar.fileGroupVO.fileDetailVOList.size() : 0}개
													</span>
										
										</span> / 6개(몇개로 할지 협의 필요)</div>
								</div>
								<ul class="upload-list" id="fileListArea">
							    <c:forEach var="fileDetailVO" items="${calendar.fileGroupVO.fileDetailVOList}" varStatus="stat">
										  <li>
										    <div class="in">
										      <div class="file-name" onclick="fn_dw(this)" class="imgFileSaveLocate" style="cursor: pointer;"  id="${fileDetailVO.fileSaveLocate}"
                     data-file-original-name="${fileDetailVO.fileOriginalName}"
                     data-file-save-locate="${fileDetailVO.fileSaveLocate}">
										        ${fileDetailVO.fileOriginalName}
										        [${fileDetailVO.fileMime}, ${fileDetailVO.fileFancySize}]
										      </div>
										      <div class="file-btn">
										       <button type="button" class="ico-del" style="display:none;" onclick="this.closest('li').remove(); deletedFileIds.push('${fileDetailVO.fileSn}')">삭제</button>
  
										        <!-- <button type="button" class="btn btn-txt ico-before ico-del sm h-auto"  style="display: none;" onclick="this.closest('li').remove(); updateFileCount();">삭제</button>
										     -->  </div>
										    </div>
										  </li>
						
						    </c:forEach>
								</ul>
								<div class="upload-delete-btn">
							<input type="file" name="uploadFiles" multiple id="uploadFiles"style="display:none;" onchange="handleFileUpload(event)" />
									<button type="button" class="btn btn-txt ico-before ico-del sm h-auto " style="display:none;" onclick="deleteAllFiles()">delete all</button>
								</div>
							</div>
       
					<%-- 	</c:if> --%>
							<!-- //파일업로드 -->
							<!-- 파일업로드 -->
							
							<!-- //파일업로드 리스트 -->
						</div>
						
						<div>
						</div>
						<div style="display:flex;justify-content: flex-end;">
							<button type="button" class="btn primary" onclick="UpdatEvent()">Modify </button>
							<button type="button" class="btn primary" onclick="updateSub()">Sumnit </button>
							<button type="button" class="btn primary" onclick="Deletevent()">Delete </button>
						</div>
					</div>
				 </div>
				<!-- //일정등록 폼 -->

					

			</div>
			<!-- //컨텐츠 영역 -->
		</div>
		<!-- //컨테이너 영역 -->

		<!-- 푸터 영역 -->
		<!-- //푸터 영역 -->
	</div>

	<!-- 레이어 : 검색필터 -->
	<div class="popup-wrap" data-type="bottom" id="popFilterId">
		<div class=" popup-in">
			<div class="popup">
				<div class="popup-head">
					<h1 class="pop-tit">검색필터</h1>
					<button type="button" class="popup-close">
						<span class="sr-only">레이어 닫기</span>
					</button>
				</div>
				<div class="popup-body">
					<div class="pop-filter-top">
						<dl class="filter-dl">
							<dt>적용된 필터 (0)</dt>
							<dd>적용된 필터가 없습니다. 검색 필터를 통해 상세한 검색을 해보세요</dd>
						</dl>
					</div>
					<ul class="acco-list filter-list is-open">
						<li class="li">
							<div class="acco-head">
								<h4 class="tit"><label for="select1">생애 주기</label></h4>
								<button type="button" class="btn btn-ico acco-btn">
									<span class="sr-only">펼침</span>
								</button>
							</div>
							<div class="acco-body">
								<div class="acco-in">
									<select class="form-select md" id="select1">
										<option value="">전체</option>
									</select>
								</div>
							</div>
						</li>
						<li class="li">
							<div class="acco-head">
								<h4 class="tit"><label for="select2">가구 상황</label></h4>
								<button type="button" class="btn btn-ico acco-btn">
									<span class="sr-only">펼침</span>
								</button>
							</div>
							<div class="acco-body">
								<div class="acco-in">
									<select class="form-select md" id="select2">
										<option value="">전체</option>
									</select>
								</div>
							</div>
						</li>
						<li class="li">
							<div class="acco-head">
								<h4 class="tit"><label for="select3">관심 주제</label></h4>
								<button type="button" class="btn btn-ico acco-btn">
									<span class="sr-only">펼침</span>
								</button>
							</div>
							<div class="acco-body">
								<div class="acco-in">
									<select class="form-select md" id="select3">
										<option value="">전체</option>
									</select>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div class="popup-btm">
					<button type="button" class="btn xlg tertiary">모든 조건 삭제</button>
					<button type="button" class="btn xlg">적용하기</button>
				</div>
			</div>
		</div>
	</div>
	<input type="hidden" id="fileGroupNo" name="fileGroupNo" value="${calendar.fileGroupNo}" />
	
	</form>
	
	<!-- //레이어 : 검색필터 -->

	<!-- 스크립트 : 라이브러리 -->
	<script src="../../resources/js/pattern/jquery.min.js"></script>

	<!-- 스크립트 : 패턴 페이지 -->
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="../../resources/js/pattern/ui-pattern-script.js"></script>
	

	<!-- 스크립트 : 컴포넌트 -->
	<script src="../../resources/js/component/ui-script.js"></script>
<script>
function citiText(){
	 
	const citySelect = document.getElementById("selectOrg");
	
	
	const cityValue = citySelect.value;
	const cityText = citySelect.options[citySelect.selectedIndex].text;
	const description =  document.getElementById("description").value;
	
	console.log("cityText",cityText)
	 
 }
/* layer : 검색필터 */
/* const $tag = document.querySelector(".pop-filter-top .tag-in");
const $tagBtn = document.querySelector(".pop-filter-top #btn-toggle");
if ($tagBtn) {
	$tagBtn.addEventListener("click", (e) => {
		if (!e.target.classList.contains("active")) {
			$tag.classList.add("is-open");
			e.target.classList.add("active");
		} else {
			$tag.classList.remove("is-open");
			e.target.classList.remove("active");
		}
	});
}
	
 */
	  let uploadedFiles = [];
	  let deletedFileIds = [];

	  function UpdatEvent() {
	    document.querySelectorAll(".delread").forEach(el => el.removeAttribute("readonly"));
	    document.querySelectorAll(".delDis").forEach(el => el.removeAttribute("disabled"));
	    document.querySelectorAll(".ico-del").forEach(el => el.style.display = "inline-block");
	    document.querySelector("#uploadFiles").style.display = "block";
	    
   	  document.querySelectorAll('.datepicker').forEach(input => {
   		  
   		 const rawValue = input.value;
	   	  if (rawValue.includes('T')) {
	   	    input.value = rawValue.split('T')[0];
   	  }
   		    input.type = 'date';
   		    input.removeAttribute("readonly")
   			  input.setAttribute('lang', 'en');
   		  });
	  }


	function deleteSingleFile(index, button, fileId) {
	  if (fileId) {
	    deletedFileIds.push(fileId); // 기존 파일일 경우 ID 저장
	  } else {
	    uploadedFiles.splice(index, 1); // 새로 올린 파일은 배열에서 제거
	  }
	  button.closest('li').remove();
	  updateFileCount();
	}


	  function updateFileCount() {
	    const countSpan = document.querySelector('.file-total .current');
	    const validCount = uploadedFiles.length;
	    countSpan.textContent = `\${validCount}개`;
	  }

	  function deleteAllFiles() {
	    uploadedFiles = [];
	    const fileListArea = document.getElementById('fileListArea');
	    fileListArea.innerHTML = '';
	    updateFileCount();
	  }


  function formatBytes(bytes) {
    if (bytes === 0) return '0KB';
    const k = 1024;
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const size = parseFloat((bytes / Math.pow(k, i)).toFixed(1));
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    return `\${size} \${sizes[i]}`;
  }

  function updateFileCount() {
    const countSpan = document.querySelector('.file-total .current');
    const validCount = uploadedFiles.length;
    countSpan.textContent = `\${validCount}개`;
  }

  function deleteAllFiles() {
    uploadedFiles = [];
    const fileListArea = document.getElementById('fileListArea');
    fileListArea.innerHTML = '';
    updateFileCount();
  }

  function handleFileUpload(event) {
    const files = event.target.files;
    const fileListArea = document.getElementById('fileListArea');

    for (let i = 0; i < files.length; i++) {
      const file = files[i];

      if (file.size > 20 * 1024 * 1024) {
        const li = document.createElement('li');
        li.classList.add('is-error');
        li.innerHTML = `
          <div class="in">
            <div class="file-name">\${file.name} [\${file.name.split('.').pop()}, \${formatBytes(file.size)}]</div>
            <div class="file-btn">
              <span class="ico-invalid error"><em class="sr-only">에러</em></span>
              <button type="button" class="btn btn-txt ico-before ico-del sm h-auto" onclick="deleteSingleFile(${uploadedFiles.length - 1}, this)">삭제</button>
            </div>
          </div>
          <p class="file-hint">등록 가능한 파일 용량을 초과하였습니다.<br>20MB 미만의 파일만 등록할 수 있습니다.</p>
        `;
        fileListArea.appendChild(li);
        continue;
      }

      if (uploadedFiles.length >= 6) {
        alert("최대 6개의 파일만 등록할 수 있습니다.");
        break;
      }

      uploadedFiles.push(file);

      const li = document.createElement('li');
      li.innerHTML = `
        <div class="in">
          <div class="file-name">\${file.name} [\${file.name.split('.').pop()}, \${formatBytes(file.size)}]</div>
          <div class="file-btn">
            <button type="button" class="btn btn-txt ico-before ico-del sm h-auto" onclick="deleteSingleFile(${uploadedFiles.length - 1}, this)">삭제</button>
          </div>
        </div>
      `;
      fileListArea.appendChild(li);
    }

    updateFileCount();
    event.target.value = '';
  }

  function deleteSingleFile(index, button) {
    uploadedFiles.splice(index, 1);
    button.closest('li').remove();
    updateFileCount();
  }


  function updateSub() {
    const formData = new FormData();
    formData.append("id", document.querySelector("#getId").value);
    formData.append("eventTitle", document.getElementById("consult_name").value);
    formData.append("startDatetime", document.getElementById("startdate").value);
    formData.append("endDatetime", document.getElementById("enddate").value);
    formData.append("eventDescription", document.getElementById("description").value);
    formData.append("organizer", document.getElementById("selectOrg").value);
   /*  formData.append("location", ""); */
   /*  formData.append("contact", ""); */
   /*  formData.append("externalLink", ""); */
    formData.append("eventStatus", document.querySelector('input[name="eventStatus"]:checked').value);
    

    if (deletedFileIds.length > 0) {
    	  formData.append("deletedFileIds", deletedFileIds.join(","));
    	}
    console.log("deletedFileIds", deletedFileIds);
    formData.append("fileGroupNo", document.getElementById("fileGroupNo").value); //  추가!

    const fileInput = document.getElementById("uploadFiles");
    console.log(fileInput.files);
 //수정된 부분
    for (let i = 0; i < uploadedFiles.length; i++) {
      formData.append("uploadFiles", uploadedFiles[i]);
    }
    document.querySelectorAll('input[name="existingFileIds"]').forEach(input => {
    	  formData.append("existingFileIds", input.value);
    	});


    axios.post("\${pageContext.request.contextPath}/modify.do", formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    })
    .then(response => {
      alert("일정이 수정되었습니다.");
      location.href = "\${pageContext.request.contextPath}/calendar.do";
    })
    .catch(error => {
      alert("수정 실패");
    });
  }

  function Deletevent() {
    const form = document.getElementById("form");
    if (confirm("삭제하시겠습니까?")) {
      form.action = "\${pageContext.request.contextPath}/calendar/delete.do";
      form.submit();
    }
  }
  
  function fn_dw(el) {
	 /*  if (el) {
	    const fileSaveLocate = el.dataset.fileSaveLocate;
	    if (fileSaveLocate) {
	      location.href = "${pageContext.request.contextPath}/download.do?fileName=" + encodeURIComponent(fileSaveLocate);
	    } else {
	      console.warn("파일 경로가 없습니다.");
	    }
	  } else {
	    // 전체 다운로드: 첫 번째 이미지 기준
	    const target = document.querySelector(".imgFileSaveLocate");
	    const fileSaveLocate = target?.dataset?.fileSaveLocate;

	    if (fileSaveLocate) {
	      location.href = "${pageContext.request.contextPath}/download.do?fileName=" + encodeURIComponent(fileSaveLocate);
	    } else {
	      console.warn("전체 다운로드 경로 없음");
	    }
	  } */
	//다운로드 버튼 이벤트
	  const target = document.querySelector(".imgFileSaveLocate");
	    console.log("el",el)
	
	  if (target) {
	    const fileSaveLocate = el.dataset.fileSaveLocate;
	    
	    console.log("fileSaveLocate : " + fileSaveLocate);
	    location.href = "\${pageContext.request.contextPath}/download.do?fileName=" + encodeURIComponent(fileSaveLocate);
	  } else {
	    console.warn("❌ .imgFileSaveLocate 요소를 찾을 수 없습니다.");
	  }
		}

</script>


</body>
</html>