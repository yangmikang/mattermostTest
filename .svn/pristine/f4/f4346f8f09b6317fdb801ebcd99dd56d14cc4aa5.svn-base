<%@ page language="java" contentType="text/html; charset=EUC-KR"
    pageEncoding="EUC-KR"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="EUC-KR">
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="ui" uri="http://egovframework.gov/ctl/ui"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles"%>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script> 
$(function(){
	$('#checkIdBtn').click(function() { 
	    var userId = $('#userId').val();
	    if (userId === '') {
	    	alert("Please enter your ID.");
	        return;
	    }
	
	    $.ajax({
	        url: '${pageContext.request.contextPath}/checkUserId.do',
	        type: 'POST',
	        data: { userId: userId },  
	        success: function(response) {
	        	if (response === 'Y') {
	        	    $('#idCheckResult').text('This username is already in use. Please choose a different one.').css('color', 'red');
	        	} else {
	        	    $('#idCheckResult').text('This username is available.').css('color', 'green');
	        	    $('#idChkYn').val("Y");
	        	}
	        },
	        error: function() {  
	        	alert('An error has occurred. Please try again later.');
	        }
	    });
	});
	
});

$(document).ready(function () {
	$('#userId').on('input', function() {
		let val = $(this).val();
		val = val.replace(/[^a-zA-Z0-9]/g, '');
	    $(this).val(val);
	    $('#idChkYn').val('N');
	    $('#idCheckResult').text('');
	});
	
	$('#confirmPassword').on('input', function () {
	    const pw = $('#password').val();
	    const cpw = $(this).val();
	
	    if (pw && cpw) {
	    	if (pw === cpw) {
	    	    $('#pwMatchMsg').text('Passwords match.').css('color', 'green');
	    	} else {
	    	    $('#pwMatchMsg').text('Passwords do not match.').css('color', 'red');  
	    	}
	    } else {
	        $('#pwMatchMsg').text('');
	    }
	});
	$('#city_code').on('change', function() {
	    if ($(this).val() === '99') {
	        $('#otherCityInput').show();
	    } else {
	        $('#otherCityInput').hide();
	    }
	});
}); 


function validateForm() {
	
    const userId = document.getElementById("userId").value.trim();
    const idChkYn = document.getElementById("idChkYn").value;
    const password = document.getElementById("password").value.trim();
    const confirmPassword = document.getElementById("confirmPassword").value.trim();
    const username = document.getElementById("username").value.trim();
    const email = document.getElementById("email").value.trim();
    const city_code = document.getElementById("city_code").value.trim();
    const city_etc = document.getElementById("city_etc").value.trim();

    if (userId === "") {
        alert("Please enter your ID.");
        return false;
    }
    
    const idRegex = /^[a-zA-Z][a-zA-Z0-9]{3,11}$/;
    if (!idRegex.test(userId)) {
        alert("ID must start with a letter and be 4 to 12 characters long, containing only letters and numbers.");
        return false;
    }
    
    if (city_code === "") {
        alert("Please select your city.");
        return false;
    }

    if (city_code === "99") {
        if (city_etc === "") {
            alert("Please enter your other city.");
            return false;
        }
        if (city_etc.length > 50) {
            alert("Other city name cannot exceed 50 characters.");
            return false;
        }
    }

    if (idChkYn !== "Y") {
        alert("Please check ID availability.");
        return false;
    }

    if (password === "") {
        alert("Please enter your password.");
        return false;
    }
    if (password.length < 8 || password.length > 20) {
        alert("Password must be between 8 and 20 characters.");
        return false;
    }

    const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$/;
    if (!pwRegex.test(password)) {
        alert("Password must include both letters and numbers.");
        return false;
    }

    if (confirmPassword === "") {
        alert("Please confirm your password.");
        return false;
    }
    if (password !== confirmPassword) {
        alert("Passwords do not match.");
        return false;
    }

    if (username === "") {
        alert("Please enter your name.");
        return false;
    }
    if (username.length < 2 || username.length > 20) {
        alert("Name must be between 2 and 20 characters.");
        return false;
    }

    if (email !== "") {
        if (email.length > 50) {
            alert("Email cannot exceed 50 characters.");
            return false;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert("Please enter a valid email address.");
            return false;
        }
    }

    return true;
}
</script>
<title>Insert title here</title>
</head>
<body>
    <h2>Sign Up</h2>
    <form action="${pageContext.request.contextPath}/register.do" method="post" onsubmit="return validateForm();">
        <label>ID: <input type="text" name="id" id="userId" required /><button type="button" id="checkIdBtn">Check Availability</button><span id="idCheckResult"></span></label><br/><br/>
        <input type="hidden" value="N" id="idChkYn"/>
        <label>Password: <input type="password" id="password" name="password" required /></label><br/><br/>
        <label>confirm Password<input type="password" name="confirmPassword" id="confirmPassword" required /></label><span id="pwMatchMsg"></span><br/><br/>
        <label>User name: <input type="text" name="username" id="username" required /></label><br/><br/>
        <label>Email: <input type="email" name="email" id="email" /></label><br/><br/>
        <label>CITY:
        	<select name="city_code" id="city_code"> 
        		<option value="">---------------</option>
        		<option value="01">Daejeon</option>
        		<option value="02">Dortmund</option>
        		<option value="03">Malaga</option>
        		<option value="04">Montgomery County</option>
        		<option value="05">Seattle</option>
        		<option value="06">Quebec City</option>
        		<option value="07">Hsinchu</option>
        		<option value="99">Other city</option>
        	</select>
        </label><br/>
        <div id="otherCityInput" style="display: none;">
		    <label>Enter Other City: <input type="text" id="city_etc" name="city_etc"></label>
		</div>
		        
        <input type="submit" value="Register" />
    </form>
</body>
</html>  