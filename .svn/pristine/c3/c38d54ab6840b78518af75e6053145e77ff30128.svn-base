<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.distep.main.service.impl.BoardMapper">

	<resultMap id="boardResultMap"
		type="kr.go.distep.main.service.vo.BoardVo">
		<result property="boardCode" column="board_code" />
		<result property="title" column="title" />
		<result property="content" column="content" />
		<result property="userId" column="user_id" />
		<result property="regDate" column="reg_date" />
		<result property="status" column="status" />
		<result property="cityCode" column="city_code" />
		<result property="boardMasterCode" column="board_master_code" />
		<result property="fileGroupNo" column="file_group_no" />
	</resultMap>

	<select id="list" resultMap="boardResultMap"
		parameterType="hashMap">
		WITH X AS (
		SELECT
		B.board_code,
		B.title,
		B.content,
		B.user_id,
		DATE_FORMAT(B.reg_date, '%Y-%m-%d') AS regDate,
		B.status,
		ROW_NUMBER() OVER (ORDER BY B.reg_date DESC) AS RNUM,
		B.file_group_no,
		B.board_master_code,
		M.username,
		M.id,
		M.city_code AS city_code
		FROM board B
		LEFT JOIN member M
		ON B.user_id = M.id
		WHERE B.status = 'Y'
		<if test="keyword != null and keyword != ''">
			AND (title LIKE CONCAT('%', #{keyword}, '%')
			OR content LIKE CONCAT('%', #{keyword}, '%'))
		</if>
		<if test="boardMasterCode != null and boardMasterCode != ''">
			AND B.board_master_code = #{boardMasterCode}
		</if>
		)
		SELECT *
		FROM X
		WHERE X.rnum BETWEEN (#{currentPage} * 9) - (9 - 1)
		AND (#{currentPage} * 9)
	</select>

	<select id="getTotal" parameterType="hashMap" resultType="int">
		WITH X AS (
		SELECT
		B.board_code,
		B.title,
		B.content,
		B.user_id,
		DATE_FORMAT(B.reg_date, '%Y-%m-%d') AS regDate,
		B.status,
		ROW_NUMBER() OVER (ORDER BY B.reg_date DESC) AS RNUM,
		B.file_group_no,
		B.board_master_code,
		M.username,
		M.id,
		M.city_code AS city_code
		FROM board B
		LEFT JOIN member M
		ON B.user_id = M.id
		WHERE B.status = 'Y'
		<if test="keyword != null and keyword != ''">
			AND (title LIKE CONCAT('%', #{keyword}, '%')
			OR content LIKE CONCAT('%', #{keyword}, '%'))
		</if>
		<if test="boardMasterCode != null and boardMasterCode != ''">
			AND B.board_master_code = #{boardMasterCode}
		</if>
		)
		SELECT COUNT(*)
		FROM X
		WHERE 1 = 1
	</select>

	<select id="detail"
		parameterType="kr.go.distep.main.service.vo.BoardVo"
		resultMap="boardResultMap">
		SELECT *
		FROM board b inner join member m
		ON b.user_id = m.id
		WHERE board_code = #{boardCode}
		<if test="boardMasterCode != null and boardMasterCode != ''">
			AND B.board_master_code = #{boardMasterCode}
		</if>

	</select>

	<!-- <update id=""></update> -->
	<insert id="boardInsert"
		parameterType="kr.go.distep.main.service.vo.BoardVo"
		useGeneratedKeys="true" keyProperty="boardCode">

		INSERT INTO board
		<trim prefix="(" suffix=")" suffixOverrides=",">
			title,
			content,
			user_id,
			reg_date,
			status,
			board_master_code,
			<if test="fileGroupNo > 0">
				file_group_no,
			</if>
		</trim>
		VALUES
		<trim prefix="(" suffix=")" suffixOverrides=",">
			#{title},
			#{content},
			#{userId},
			SYSDATE(),
			'Y',
			#{boardMasterCode},
			<if test="fileGroupNo > 0">
				#{fileGroupNo},
			</if>
		</trim>
	</insert>

	<update id="updateBd"
		parameterType="kr.go.distep.main.service.vo.BoardVo">
		update board
		set title = #{title} , content =#{content},file_group_no =
		#{fileGroupNo}, updated_at = NOW()
		where board_code = #{boardCode}

	</update>
	<update id="deleteBd"
		parameterType="kr.go.distep.main.service.vo.BoardVo">
		update board
		set status = 'N'
		where board_code = #{boardCode}
	</update>

</mapper>