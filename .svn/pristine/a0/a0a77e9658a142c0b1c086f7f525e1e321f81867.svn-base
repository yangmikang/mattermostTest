<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>

<!DOCTYPE html>
<html>
<head>
<title>Insert title here</title>
</head>
<style>
		#content{
		    width: 80%;
    		margin: 0 auto;
			margin-bottom: 5%;
			margin-top: 2%;
	}
	.subBt, .fileIp {
		display: none ; 
	}
	td> .ip {
	width:50%;}


form  button{

border: 1px solid black;
width: 80px;
height: 30px;

}
</style>

		
	
<body>
  	<div id="wrap">
		<!-- 컨테이너 영역 -->
		<div id="container">
			<!-- breadcrumb -->
			<nav class="breadcrumb-wrap" aria-label="브레드크럼">
				<ol class="breadcrumb">
					<li class="home"><a href="#" class="txt">Home</a></li>
					<li><a href="#" class="txt">Board</a></li>
					<li><a href="#" class="txt">News</a></li>
					<li><a href="#" class="txt">Detail</a></li>
				</ol>
			</nav>
			<!-- breadcrumb -->
  	
  <form class="form-horizontal" id="form" action="/contract/create"
	method="post" enctype="multipart/form-data">
	
	<input type="hidden" name="fileGroupNo" value="${boardVo.fileGroupNo}" />
	
	<input type="hidden" class="ip" name="boardCode"
						value="${boardVo.boardCode}" id="" readonly>
	<input type="hidden" class="ip" name=""
						value="${boardVo.cityCode}" id="" readonly>
			<!-- 컨텐츠 영역 -->
			<div class="inner">
				<!-- 페이지 타이틀 영역 -->
				<div class="page-title-wrap">
					<h2 class="h-tit">Board Detail</h2>
				</div>
				<!-- //페이지 타이틀 영역 -->
				<!-- 상세보기 영역 -->
				<div class="conts-area">
					<div class="conts-detail-wrap txt-box bg-white">
						<!-- real contents -->
						<div class="conts-wrap scroll-check">
							<div class="conts-wrap section-link" id="section_01">
								<h3 class="sec-tit">
								<input type="text" id="boardIP" name="title" style="width:1200px; border:none;" class="updtcon ip title" value="${boardVo.title}" readonly></h3>
								<input type="text" id="boardMasterCode" name="title" style="width:1200px; border:none;" class="updtcon ip title" value="${boardVo.boardMasterCode}" readonly></h3>
								<!-- table list -->
								<div class="tbl-wrap">
									<dl class="tbl def-list">
										<!-- <dt>Title</dt>
										<dd><h3 class="sec-tit">제목입력해주세요</h3></dd> -->
										<dt>Author</dt>
										
										<dd  style=" display: flex; align-items: center;">
										  <c:choose>
										    <c:when test="${boardVo.cityCode == '01'}">
										      <!-- Daejeon / South Korea -->
										      <img src="${pageContext.request.contextPath}/img/component/common/ico_korea.svg" alt="Korea Flag" />
										    </c:when>
										    <c:when test="${boardVo.cityCode == '02'}">
										      <!-- Dortmund / Germany -->
										      <img src="${pageContext.request.contextPath}/img/component/common/ico_germany.svg" alt="Germany Flag" />
										    </c:when>
										    <c:when test="${boardVo.cityCode == '03'}">
										      <!-- Malaga / Spain -->
										      <img src="${pageContext.request.contextPath}/img/component/common/ico_spain.svg" alt="Spain Flag" />
										    </c:when>
										    <c:when test="${boardVo.cityCode == '04' || boardVo.cityCode == '05'}">
										      <!-- Montgomery County / Seattle => USA -->
										      <img src="${pageContext.request.contextPath}/img/component/common/ico_usa.svg" alt="USA Flag" />
										    </c:when>
										    <c:when test="${boardVo.cityCode == '06'}">
										      <!-- Quebec / Canada -->
										      <img src="${pageContext.request.contextPath}/img/component/common/ico_canada.svg" alt="Canada Flag" />
										    </c:when>
										    <c:otherwise>
										      <!-- Other / Unknown -->
										      <img src="${pageContext.request.contextPath}/img/component/common/ico_global.svg" alt="Global Flag" />
										    </c:otherwise>
										    </c:choose>
											${boardVo.username}</dd>
										<dt>Reg Date</dt>
										<dd>${boardVo.regDate}</dd>
										<dt>Content</dt>
										<dd><textarea rows="10" cols="100" name="content" class="updtcon content" readonly style="border:none;">${boardVo.content}</textarea>
										</dd>
										<c:if test="${boardVo.fileGroupVO != null}">
										<dt style="display: block;width: 100%;">Upload File</dt>
										    <c:forEach var="fileDetailVO" items="${boardVo.fileGroupVO.fileDetailVOList}" varStatus="stat">
										            <td colspan="2">
										               <img class="img-fluid imgFileSaveLocate" style="display: none;" src="<c:url value='${fileDetailVO.fileSaveLocate}' />"
										                     data-file-original-name="${fileDetailVO.fileOriginalName}"
										                     data-file-save-locate="${fileDetailVO.fileSaveLocate}"   /> 
										                     <img src="${file.fileSaveLocate}" />
										            </td>
										            
										        <tr>
										        </tr>
										 
										<dd>
											<ul class="box-group-area">
												<li>
												
													<p class="tit">${fileDetailVO.fileOriginalName} [${fileDetailVO.fileExt}, ${fileDetailVO.fileFancySize}]</p>
													<div class="btn-wrap">
														<button type="button" class="btn sm btn-txt ico-down down" onclick="fn_dw()">Download</button>
														<!-- <button type="button" class="btn sm btn-txt ico-go">View</button> -->
													</div>
												</li>
											</ul><input type="hidden" name="existingFileIds" value="${fileDetailVO.fileGroupNo}" />
											
										</dd>   </c:forEach>
										</c:if>
								</div>
								
								<div class="gini-cont-box" style="display:none;">
						<div class="row">
							<!-- 파일업로드 -->
							<div class="file-upload cont50" ondragover="f_over()"   ondrop="f_drop()">
								<p class="txt">Please drag and drop the file you wish to attach here, or click the Select File button to select the file directly.</p>
								<button type="button" class="btn primary ico-before ico-upload md" onclick="document.getElementById('uploadFiles').click()">
Select file</button>
							
							<input type="file" name="uploadFiles" multiple id="uploadFiles"style="display:none;" onchange="handleFileUpload(event)" />
							</div>
							<!-- //파일업로드 -->
							<!-- 파일업로드 -->
							<div class="file-upload-result cont50">
								<div class="upload-top">
									<div class="file-total"><span class="current">0개</span> / 6개(몇개로 할지 협의 필요)</div>
								</div>
								<ul class="upload-list" id="fileListArea">
								</ul>
								<div class="upload-delete-btn">
									<button type="button" class="btn btn-txt ico-before ico-del sm h-auto " onclick="deleteAllFiles()">delete all</button>
								</div>
							</div>
							<!-- //파일업로드 리스트 -->
						</div>
						
					</div>
								<!-- //table list -->
							</div>
							
						</div>
						<!-- //real contents -->
						 <div class="page-btn-wrap both">
							<div>
							
							 <c:choose>
										    <c:when test="${boardVo.boardMasterCode == 'N01'}">
										      <!-- Daejeon / South Korea -->
											<button type="button" class="btn xlg" onclick="location.href='${pageContext.request.contextPath}/board/boardthumb.do'">Go to list</button>
										    </c:when>
										    <c:when test="${boardVo.boardMasterCode == 'N02'}">
										      <!-- Dortmund / Germany -->
											<button type="button" class="btn xlg" onclick="location.href='${pageContext.request.contextPath}/board/home.do'">Go to list</button>
										    </c:when>
										    <c:when test="${boardVo.boardMasterCode == 'N03'}">
										      <!-- Malaga / Spain -->
											<button type="button" class="btn xlg" onclick="location.href='${pageContext.request.contextPath}/board/home.do'">Go to list</button>
										    </c:when>
										    <c:otherwise>
										      <!-- Other / Unknown -->
											<button type="button" class="btn xlg" onclick="location.href='${pageContext.request.contextPath}/board/home.do'">Go to list</button>
										    </c:otherwise>
										    </c:choose>
							</div>
							<div>
								<input type="checkbox" name="deleteFileIds" value="${fileDetailVO.fileNo}" />
								<button type="button" class="btn xlg edit" onclick="updateBd()">Edit</button>
								<button type="submit" class="btn xlg subBt" >Submit</button>
								<button type="button" class="btn xlg tertiary delete" onclick="deleteBd()">Delete</button>
							</div>
						</div>
					</div>
				</div>



				<!-- //상세보기 영역 -->
			</div>
		<!-- //컨테이너 영역 -->

		
	</div>
</form><%-- <c:forEach var="file" items="${fileList}">
    <c:if test="${file.fileType == 'THUMBNAIL'}">
        <!-- 썸네일 파일 출력 -->
        <img src="${pageContext.request.contextPath}/file/download.do?fileId=${file.fileSn}" alt="썸네일" />
    </c:if>
</c:forEach>
 --%>
	
<script type="text/javascript">

//location.href = encodeURI(`${fileDetailVO.fileSaveLocate}`);

//전역 파일 저장 배열
let uploadedFiles = [];

function formatBytes(bytes) {
  if (bytes === 0) return '0KB';
  const k = 1024;
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  const size = parseFloat((bytes / Math.pow(k, i)).toFixed(1));
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  return `\${size} \${sizes[i]}`;
}

function updateFileCount() {
  const countSpan = document.querySelector('.file-total .current');
  const validCount = uploadedFiles.length;
  countSpan.textContent = `\${validCount}개`;
}

function deleteAllFiles() {
  uploadedFiles = [];
  const fileListArea = document.getElementById('fileListArea');
  fileListArea.innerHTML = '';
  updateFileCount();
}

function handleFileUpload(event) {
  const files = event.target.files;
  const fileListArea = document.getElementById('fileListArea');

  for (let i = 0; i < files.length; i++) {
    const file = files[i];

    if (file.size > 20 * 1024 * 1024) {
      const li = document.createElement('li');
      li.classList.add('is-error');
      li.innerHTML = `
        <div class="in">
          <div class="file-name">\${file.name} [\${file.name.split('.').pop()}, \${formatBytes(file.size)}]</div>
          <div class="file-btn">
            <span class="ico-invalid error"><em class="sr-only">에러</em></span>
            <button type="button" class="btn btn-txt ico-before ico-del sm h-auto" onclick="this.closest('li').remove(); updateFileCount();">삭제</button>
          </div>
        </div>
        <p class="file-hint">등록 가능한 파일 용량을 초과하였습니다.<br>20MB 미만의 파일만 등록할 수 있습니다.</p>
      `;
      fileListArea.appendChild(li);
      continue;
    }

    if (uploadedFiles.length >= 6) {
      alert("최대 6개의 파일만 등록할 수 있습니다.");
      break;
    }

    uploadedFiles.push(file);

    const li = document.createElement('li');
    li.innerHTML = `
      <div class="in">
        <div class="file-name">\${file.name} [\${file.name.split('.').pop()}, \${formatBytes(file.size)}]</div>
        <div class="file-btn">
          <button type="button" class="btn btn-txt ico-before ico-del sm h-auto" onclick="this.closest('li').remove(); updateFileCount();">삭제</button>
        </div>
      </div>
    `;
    fileListArea.appendChild(li);
  }

  updateFileCount();
  //event.target.value = '';
}

function deleteSingleFile(index, button) {
  uploadedFiles.splice(index, 1);
  button.closest('li').remove();
  updateFileCount();
}


  // 전역 함수로 선언 (HTML onclick에서도 접근 가능)
  function updateBd() {
	  document.querySelector(".edit").style.display = 'none';
	  document.querySelector(".subBt").style.display = 'inline-flex';
	  document.querySelector(".gini-cont-box").style.display = 'block';

	  document.querySelectorAll(".updtcon").forEach(function (el) {
	    el.removeAttribute("readonly");
	    el.style.border = "1px solid gray";
	  });

	  const form = document.getElementById("form");
	  form.setAttribute("action", "${pageContext.request.contextPath}/board/update.do");
	  form.setAttribute("method", "post");
  }

  function deleteBd() {
    const form = document.getElementById("form");
    form.setAttribute("action", "${pageContext.request.contextPath}/board/delete.do");

    const result = confirm("삭제하시겠습니까?");
    if (result) {
      form.submit();
      let boardMasterCode = ${boardVo.boardMasterCode};
	  if(boardMasterCode == 'N01'){
	      location.href='${pageContext.request.contextPath}/board/boardthumb.do'
	  }if (boardMasterCode == 'N02'){
	      location.href='${pageContext.request.contextPath}/board/home.do'
	  }
      
      
      
      
    } else {
      alert("삭제 취소되었습니다");
    }
  }

 function fn_dw() {
    // 다운로드 버튼 이벤트
      const target = document.querySelector(".imgFileSaveLocate");

      if (target) {
        const fileSaveLocate = target.dataset.fileSaveLocate;
        console.log("fileSaveLocate : " + fileSaveLocate);
        location.href = "${pageContext.request.contextPath}/download.do?fileName=" + encodeURIComponent(fileSaveLocate);
      } else {
        console.warn(".imgFileSaveLocate 요소를 찾을 수 없습니다.");
      }
    
  };
</script>
</body>
</html>
