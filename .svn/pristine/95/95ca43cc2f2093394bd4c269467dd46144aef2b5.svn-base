<%@ page language="java" contentType="text/html; charset=EUC-KR"
    pageEncoding="EUC-KR"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="EUC-KR">
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="ui" uri="http://egovframework.gov/ctl/ui"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="tiles" uri="http://tiles.apache.org/tags-tiles"%>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script> 
$(function(){
	$('#checkIdBtn').click(function() { 
	    var userId = $('#userId').val();
	    if (userId === '') {
	        alert('아이디를 입력하세요.');
	        return;
	    }
	
	    $.ajax({
	        url: '${pageContext.request.contextPath}/checkUserId.do',
	        type: 'POST',
	        data: { userId: userId },  
	        success: function(response) {
	            if (response === 'Y') {
	                $('#idCheckResult').text('이미 사용 중인 아이디입니다.').css('color', 'red');
	            } else {
	                $('#idCheckResult').text('사용 가능한 아이디입니다.').css('color', 'green');
	                $('#idChkYn').val("Y");
	            }
	        },
	        error: function() {  
	            alert('오류가 발생했습니다.');
	        }
	    });
	});
	
	function validateForm() {
	    const userId = document.getElementById("userId").value.trim();
	    const idChkYn = document.getElementById("idChkYn").value;
	    const password = document.getElementById("password").value.trim();
	    const confirmPassword = document.getElementById("confirmPassword").value.trim();
	    const username = document.querySelector("input[name='username']").value.trim();
	    const email = document.querySelector("input[name='email']").value.trim();

	    if (userId === "") {
	        alert("ID를 입력하세요.");
	        return false;
	    }

	    if (idChkYn !== "Y") {
	        alert("ID 중복 확인을 해주세요.");
	        return false;
	    }

	    if (password === "") {
	        alert("비밀번호를 입력하세요.");
	        return false;
	    }
	    if (confirmPassword === "") {
	        alert("비밀번호를 다시 입력하세요.");
	        return false;
	    }
	    
	    if (password.length < 8) {
	        alert("비밀번호는 최소 8자 이상이어야 합니다.");
	        return false;
	    }

	    const pwRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*#?&]{8,}$/;
	    if (!pwRegex.test(password)) {
	        alert("비밀번호는 영문과 숫자를 포함해야 합니다.");
	        return false;
	    }
	    
	    if (password !== confirmPassword) {
	        alert("비밀번호가 일치하지 않습니다.");
	        return false;
	    }

	    if (username === "") {
	        alert("이름을 입력하세요.");
	        return false;
	    }

	    if (email !== "") {
	        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
	        if (!emailRegex.test(email)) {
	            alert("유효한 이메일 주소를 입력하세요.");
	            return false;
	        }
	    }

	    return true;
	}
	
});

$(document).ready(function () {
	$('#userId').on('input', function() {
	    $('#idChkYn').val('N');
	    $('#idCheckResult').text('');
	});
	
	$('#confirmPassword').on('input', function () {
	    const pw = $('#password').val();
	    const cpw = $(this).val();
	
	    if (pw && cpw) {
	        if (pw === cpw) {
	            $('#pwMatchMsg').text('비밀번호 일치').css('color', 'green');
	        } else {
	            $('#pwMatchMsg').text('비밀번호 불일치').css('color', 'red');  
	        }
	    } else {
	        $('#pwMatchMsg').text('');
	    }
	});
});
</script>
<title>Insert title here</title>
</head>
<body>
    <h2>Sign Up</h2>
    <form action="${pageContext.request.contextPath}/register.do" method="post" onsubmit="return validateForm();">
        <label>ID: <input type="text" name="id" id="userId" required /><button type="button" id="checkIdBtn">Check Availability</button><span id="idCheckResult"></span></label><br/><br/>
        <input type="hidden" value="N" id="idChkYn"/>
        <label>Password: <input type="password" id="password" name="password" required /></label><br/><br/>
        <label>confirm Password<input type="password" name="confirmPassword" id="confirmPassword" required /></label><span id="pwMatchMsg"></span><br/><br/>
        <label>User name: <input type="text" name="username" required /></label><br/><br/>
        <label>Email: <input type="email" name="email" /></label><br/><br/>
        <label>CITY:
        	<select name="city"> 
        		<option>---------------</option>
        		<option>Daejeon</option>
        		<option>Dortmund</option>
        		<option>Malaga</option>
        		<option>Montgomery County</option>
        		<option>Seattle</option>
        		<option>Quebec City</option>
        		<option>Hsinchu</option>
        		<option>Other city</option>
        	</select>
        </label><br/>
        <input type="submit" value="Register" />
    </form>
</body>
</html>  