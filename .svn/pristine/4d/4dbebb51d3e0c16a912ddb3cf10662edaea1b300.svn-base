<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
	<meta name="keywords" content="" />
	<meta name="description" content="" />
	<meta name="format-detection" content="telephone=no" />
	<link rel="apple-touch-icon" sizes="180x180" href="../../resources/img/guide/favicon_180.png">
	<link rel="icon" type="image/png" sizes="512x512" href="../../resources/img/guide/favicon_512.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="../../resources/img/guide/favicon_192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../../resources/img/guide/favicon_32.png">
	<title>GINI - Global Innopolis Network Initiative</title>
	<link href="../../resources/css/swiper-bundle.min.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/pattern_css.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/output/p_common.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/output/p_content.css" type="text/css" rel="stylesheet" />
	<link href="../../resources/css/output/p_layout.css" type="text/css" rel="stylesheet" />
</head>
<style>

	#content{
		    width: 80%;
    		margin: 0 auto;
			margin-bottom: 5%;
			margin-top: 2%;
	}
</style>
<body>
<!-- 컨테이너 영역 -->
		<c:if test="${empty sessionScope.loggedInUser}">
			<script type="text/javascript">
				alert("로그인 후 이용 가능합니다.");
				location.href = "${pageContext.request.contextPath}/login.do";
			
			</script>
		</c:if>
		
	<div id="wrap">
		<!-- 컨테이너 영역 -->
		<div id="container">
			<!-- breadcrumb -->
			<nav class="breadcrumb-wrap" aria-label="브레드크럼">
				<ol class="breadcrumb">
					<li class="home"><a href="#" class="txt">Home</a></li>
					<li><a href="#" class="txt">Board</a></li>
					<li><a href="#" class="txt">News</a></li>
					<li><a href="#" class="txt">Detail</a></li>
				</ol>
			</nav>
			<!-- breadcrumb -->
		<form class="form-horizontal" id="form" name="form" action="${pageContext.request.contextPath}/board/boardInsert.do"
			method="post" enctype="multipart/form-data"   onsubmit="return validateFormAndSubmit()"> <!--  여기에 onsubmit 추가 -->
	
			<!-- 컨텐츠 영역 -->
			<div class="inner">
				<!-- 페이지 타이틀 영역 -->
				<div class="page-title-wrap">
					<h2 class="h-tit">Write a post</h2>
				</div>
				<!-- //페이지 타이틀 영역 -->
				<!-- 상세보기 영역 -->
				<div class="conts-area">
					<div class="conts-detail-wrap txt-box bg-white board-insert">
						<!-- real contents -->
						<div class="conts-wrap scroll-check">
							<div class="conts-wrap section-link" id="section_01">
								<!-- table list -->
								<div class="tbl-wrap">
									<dl class="tbl def-list">
										<dt class="form-tit">
											<label for="edit_title">Title</label>
										</dt>
										<dd>
											<input type="hidden" id="edit_title" maxlength="100" class="form-control boardMasterCode" autocomplete="on" placeholder="boardMasterCode" name="boardMasterCode" value="N02">
										
											<div class="form-conts">
												<input type="text" id="edit_title" maxlength="100" class="form-control" autocomplete="on" placeholder="title" name="title">
											</div>
										</dd>
										<dt class="form-tit">
											<label for="edit_content">Content</label>
										</dt>
										<dd>
											<div class="form-conts">
												<textarea rows="10" cols="50" id="edit_content"  maxlength="2000" class="form-control" name="content" placeholder="content" ></textarea>
											</div>
										</dd>
								<!-- 		<dt class="form-tit">
											<label for="edit_upload">Upload Thumbnail</label>
										</dt> -->
										<!-- <dd>
												<div class="form-group margin-b">
													<div class="form-tit lg">
														<label for="">Upload Thumbnail</label>
													</div>
													<div class="form-conts row">
														<input id="userId" type="text" maxlength="16" class="form-control">
														<button type="button" class="btn lg secondary" onclick="document.getElementById('thumbnail').click()"> Search </button>
													</div>
													<p class="form-hint info"> 
														Allow up to 00 bytes 
													</p>
														<input type="file" name="thumbnailFile" id="thumbnail" style="display:none;" onchange="" >
												</div> 
										</dd> -->
										<dt class="form-tit">
											<label for="edit_upload">Upload File</label>
										</dt>
										<dd>
											<div class="gini-cont-box">
											<div class="row">
												<!-- 파일업로드 -->
												<div class="file-upload cont50" ondragover="f_over()"   ondrop="f_drop()">
													<p class="txt">Please drag and drop the file you wish to attach here, or click the Select File button to select the file directly.</p>
													<button type="button" class="btn primary ico-before ico-upload md" onclick="document.getElementById('uploadFiles').click()">Select file</button>
													<input type="file" id="uploadFiles" name="uploadFiles" multiple style="display:none;"  onchange="handleFileUpload(event)" >
											
												</div>
												<!-- //파일업로드 -->
												<!-- 파일업로드 -->
												<div class="file-upload-result cont50">
													<div class="upload-top">
														<div class="file-total"><span class="current">0개</span> / 6개(몇개로 할지 협의 필요)</div>
													</div>
													<ul class="upload-list" id="fileListArea">
													</ul>
													<div class="upload-delete-btn">
														<button type="button" class="btn btn-txt ico-before ico-del sm h-auto " onclick="deleteAllFiles()">delete all</button>
													</div>
												</div>
												<!-- //파일업로드 리스트 -->
												<!-- //폼그룹 -->
											</div>
											
										</div>
										</dd>
									</dl>
								</div>
								<!-- //table list -->
							</div>
							
						</div>
						<!-- //real contents -->
						 <div class="page-btn-wrap both">
							<div>
								<button type="submit" class="btn xlg tertiary">Register</button>
							</div>
							<div>
								<button type="button" class="btn xlg" onclick="location.href='${pageContext.request.contextPath}/board/home.do'">목록</button>
							</div>
						</div>
					</div>
				</div>

</form>
				<!-- //상세보기 영역 -->
			</div>
		<!-- //컨테이너 영역 -->

		
	</div>
</body>

<script type="text/javascript">



//전역 파일 저장 배열


let uploadedFiles = [];

function formatBytes(bytes) {
  if (bytes === 0) return '0KB';
  const k = 1024;
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  const size = parseFloat((bytes / Math.pow(k, i)).toFixed(1));
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  return `\${size} \${sizes[i]}`;
}

function updateFileCount() {
  const countSpan = document.querySelector('.file-total .current');
  const validCount = uploadedFiles.length;
  countSpan.textContent = `\${validCount}개`;
}

function deleteAllFiles() {
  uploadedFiles = [];
  const fileListArea = document.getElementById('fileListArea');
  fileListArea.innerHTML = '';
  updateFileCount();
}

function handleFileUpload(event) {
  const files = event.target.files;
  const fileListArea = document.getElementById('fileListArea');

  console.log("파일 선택됨:", files);
  console.log("현재 uploadedFiles 배열:", uploadedFiles);
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (!files || files.length === 0) {
        console.warn("파일이 선택되지 않았습니다.");
        return;
      }
    if (file.size > 20 * 1024 * 1024) {
      const li = document.createElement('li');
      li.classList.add('is-error');
      li.innerHTML = `
        <div class="in">
          <div class="file-name">\${file.name} [\${file.name.split('.').pop()}, \${formatBytes(file.size)}]</div>
          <div class="file-btn">
            <span class="ico-invalid error"><em class="sr-only">에러</em></span>
            <button type="button" class="btn btn-txt ico-before ico-del sm h-auto" onclick="this.closest('li').remove(); updateFileCount();">삭제</button>
          </div>
        </div>
        <p class="file-hint">등록 가능한 파일 용량을 초과하였습니다.<br>20MB 미만의 파일만 등록할 수 있습니다.</p>
      `;
      fileListArea.appendChild(li);
      continue;
    }

    if (uploadedFiles.length >= 6) {
      alert("최대 6개의 파일만 등록할 수 있습니다.");
      break;
    }

    uploadedFiles.push(file);
    const currentIndex = uploadedFiles.length - 1; // 배열의 인덱스

    const li = document.createElement('li');
    li.innerHTML = `
      <div class="in">
        <div class="file-name">\${file.name} [\${file.name.split('.').pop()}, \${formatBytes(file.size)}]</div>
        <div class="file-btn">
          <button type="button" class="btn btn-txt ico-before ico-del sm h-auto"
            onclick="deleteSingleFile(${currentIndex}, this)">삭제</button>
        </div>
      </div>
    `;

    fileListArea.appendChild(li);
  }

  updateFileCount();
 // event.target.value = '';
}

function deleteSingleFile(index, button) {
  uploadedFiles.splice(index, 1);
  button.closest('li').remove();
  updateFileCount();
}

function validateFormAndSubmit() {
    var title = document.forms["form"]["title"].value.trim();
    var content = document.forms["form"]["content"].value.trim();

    if (title === "") {
        alert("제목을 입력해주세요.");
        return false;
    }
    if (title.length > 100) {
        alert("제목은 100자 이하로 입력해주세요.");
        return false;
    }
    if (content === "") {
        alert("내용을 입력해주세요.");
        return false;
    }
    if (content.length < 10) {
        alert("내용은 최소 10자 이상 입력해주세요.");
        return false;
    }
    if (content.length > 2000) {
        alert("내용은 2000자 이하로 입력해주세요.");
        return false;
    }

    const formData = new FormData();

    formData.append("title", title);
    formData.append("content", content);

    // ✅ 일반 파일 업로드 추가
    uploadedFiles.forEach(file => {
        formData.append("uploadFiles", file);
    });

    // ✅ 썸네일 파일 추가
    const thumbnailInput = document.getElementById("thumbnail");
    if (thumbnailInput.files.length > 0) {
        formData.append("thumbnailFile", thumbnailInput.files[0]);
    }

    fetch("${pageContext.request.contextPath}/board/boardInsert.do", {
        method: "POST",
        body: formData
    }).then(response => {
        if (response.ok) {
            alert("등록이 완료되었습니다.");
            location.href = "${pageContext.request.contextPath}/board/home.do";
        } else {
            alert("등록 중 오류가 발생했습니다.");
        }
    });

    return false; // 기존 form 제출 막기
}


</script>
</html>