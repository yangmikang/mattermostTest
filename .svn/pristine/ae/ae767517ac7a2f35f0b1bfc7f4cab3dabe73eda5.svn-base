<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.distep.statis.service.impl.StatisMapper">

	<resultMap id="statisResultMap"
		type="kr.go.distep.statis.vo.StatisVo">
		<result column="rnum" property="rnum" />
		<result column="log_date" property="logDate" />
		<result column="log_month" property="logMonth" />
		<result column="startDate" property="startDate" />
		<result column="endDate" property="endDate" />
		<result column="date_group" property="date_group" />
		<result column="group_key" property="group_key" />
		<result column="role" property="role" />
		<result column="statType" property="statType" />
		<result column="cnt" property="cnt" />
	</resultMap>

	<select id="getMonthlyTotalRequests" resultMap="statisResultMap"
		parameterType="hashMap">
		SELECT
		ROW_NUMBER() OVER (ORDER BY log_month DESC) AS
		rnum,
		t.log_month,
		t.request_count
		FROM ( SELECT
		DATE_FORMAT(log_time, '%Y-%m') AS log_month,
		COUNT(*) AS request_count
		FROM request_log
		GROUP BY DATE_FORMAT(log_time, '%Y-%m')
		) t
		ORDER BY t.log_month DESC
	</select>

	<select id="getDailyTotalRequests" resultMap="statisResultMap"
		parameterType="hashMap">
		SELECT
		ROW_NUMBER() OVER (ORDER BY DATE(log_time) DESC)
		AS rnum,
		DATE(log_time) AS log_date,
		COUNT(*) AS request_count
		FROM
		request_log
		GROUP BY log_date
		ORDER BY log_date DESC
	</select>

	<select id="getDailyRequestsByRole" resultMap="statisResultMap"
		parameterType="hashMap">
		SELECT
		ROW_NUMBER() OVER (ORDER BY DATE(rl.log_time)
		DESC, m.role) AS rnum,
		m.role,
		DATE(rl.log_time) AS log_date,
		COUNT(*) AS
		request_count
		FROM
		request_log rl JOIN member m ON rl.user_id = m.id
		WHERE rl.user_id != 'anonymous'
		GROUP BY m.role, log_date
		ORDER BY
		log_date DESC, m.role
	</select>

	<select id="getStatis" resultMap="statisResultMap" parameterType="hashMap">
  SELECT
    ROW_NUMBER() OVER (ORDER BY date_group, group_key) AS rnum,
    date_group,
    group_key,
    cnt
  FROM (
    SELECT
      <choose>
        <when test="dateUnit == 'year'">
          DATE_FORMAT(log_time, '%Y') AS date_group
        </when>
        <when test="dateUnit == 'month'">
          DATE_FORMAT(log_time, '%Y-%m') AS date_group
        </when>
        <when test="dateUnit == 'day'">
          DATE_FORMAT(log_time, '%Y-%m-%d') AS date_group
         </when>
        <otherwise>
          DATE_FORMAT(log_time, '%Y') AS date_group
        </otherwise>
      </choose>,

      <choose>
        <when test="statType == 'city'">
          IFNULL(NULLIF(city_code, ''), 'N') AS group_key
        </when>
        <when test="statType == 'role'">
          IFNULL(NULLIF(role, ''), 'N') AS group_key
        </when>
        <otherwise>
          'Total' AS group_key
        </otherwise>
      </choose>,

      COUNT(*) AS cnt
    FROM request_log
    <where>
      log_time BETWEEN #{startDate} AND #{endDate}
      <if test="statType == 'role'">
        AND IFNULL(NULLIF(role, ''), 'N') != 'A'
      </if>
    </where>
    GROUP BY
      <choose>
        <when test="dateUnit == 'year'">
          DATE_FORMAT(log_time, '%Y')
        </when>
        <when test="dateUnit == 'month'">
          DATE_FORMAT(log_time, '%Y-%m')
        </when>
        <when test="dateUnit == 'day'">
           DATE_FORMAT(log_time, '%Y-%m-%d')
        </when>
        <otherwise>
           DATE_FORMAT(log_time, '%Y')
        </otherwise>
      </choose>
      
      <if test="statType != 'total'">
        , <choose>
            <when test="statType == 'city'">IFNULL(NULLIF(city_code, ''), 'N')</when>
            <when test="statType == 'role'">IFNULL(NULLIF(role, ''), 'N')</when>
          </choose>
      </if>
  ) stat
</select>



</mapper>
