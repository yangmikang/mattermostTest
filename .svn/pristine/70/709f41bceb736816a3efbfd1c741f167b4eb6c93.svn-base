package kr.go.distep.main.service.impl;

import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import kr.go.distep.main.service.BoardMasterService;
import kr.go.distep.main.service.UploadService;
import kr.go.distep.main.service.vo.BoardVo;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class BoardMasterServiceImpl implements BoardMasterService {

    @Autowired
    private BoardMapper boardMapper;

    @Autowired
    private UploadService uploadService;

    @Override
    public List<BoardVo> list(Map<String, Object> map) {
        return this.boardMapper.list(map);
    }

    @Override
    public int getTotal(Map<String, Object> map) {
        return this.boardMapper.getTotal(map);
    }

    @Override
    public BoardVo detail(BoardVo boardVo) {
        return this.boardMapper.detail(boardVo);
    }

    @Override
    public int boardInsert(BoardVo boardVo) {
        try {
            MultipartFile[] uploadFiles = boardVo.getUploadFiles();

            if (uploadFiles != null && uploadFiles[0].getOriginalFilename().length() > 0) {
                long fileGroupNo = this.uploadService.multiImageUpload(uploadFiles);
                boardVo.setFileGroupNo(fileGroupNo);
            }

            log.info("ğŸ”¥ boardInsert ì‹¤í–‰ ì§ì „ íŒŒë¼ë¯¸í„°: {}", boardVo);

            int result = boardMapper.boardInsert(boardVo); // â— ì˜ˆì™¸ ë°œìƒ ì§€ì 
            log.info("âœ… boardMapper insert result: {}", result);
            return result;

        } catch (Exception e) {
            log.error("âŒ boardInsert ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
            throw new RuntimeException("boardInsert ì‹¤íŒ¨", e);
        }
    }
    @Override
    public int updateBd(BoardVo boardVo) {
        try {
            MultipartFile[] uploadFiles = boardVo.getUploadFiles();

            if (uploadFiles != null && uploadFiles.length > 0 && !uploadFiles[0].isEmpty()) {
                // ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìœ¼ë©´ ì—…ë¡œë“œ í›„ ê·¸ë£¹ë²ˆí˜¸ êµì²´
                if (boardVo.getFileGroupNo() != 0) {
                    // ê¸°ì¡´ íŒŒì¼ì´ ìˆë‹¤ë©´ ì‚­ì œí•  ìˆ˜ë„ ìˆìŒ
                    // uploadService.deleteFileGroup(boardVo.getFileGroupNo());
                }

                long newFileGroupNo = uploadService.multiImageUpload(uploadFiles);
                boardVo.setFileGroupNo(newFileGroupNo);
            } else {
                // â— ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš° â†’ ê¸°ì¡´ fileGroupNo ìœ ì§€
                log.info("ğŸ“Œ ìƒˆ íŒŒì¼ ì—†ìŒ â†’ ê¸°ì¡´ fileGroupNo ìœ ì§€: {}", boardVo.getFileGroupNo());
            }

            log.info("ğŸ”¥ updateBd ì‹¤í–‰ íŒŒë¼ë¯¸í„°: {}", boardVo);
            return boardMapper.updateBd(boardVo);

        } catch (Exception e) {
            log.error("âŒ updateBd ì¤‘ ì˜ˆì™¸ ë°œìƒ: {}", e.getMessage(), e);
            throw new RuntimeException("ê²Œì‹œê¸€ ìˆ˜ì • ì‹¤íŒ¨", e);
        }
    }


	@Override
	public int deleteBd(BoardVo boardVo) {
		return this.boardMapper.deleteBd(boardVo);
	}

}
